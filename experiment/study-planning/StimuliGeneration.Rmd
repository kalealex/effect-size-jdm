---
title: "Stimuli Generation"
author: "Alex Kale"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=10.26667, fig.height=6.16000)
library(modelr)
library(gganimate)
library(tidybayes) # devtools::install_github("mjskay/tidybayes@dev")
library(RColorBrewer)
library(gridExtra)
library(grid)
library(randtoolbox)
library(tidyverse)
```

This file contains code to generate stimuli for our effect size judgment and decision-making experiment.

##Data Conditions

In pilot 5, we change our approach to manipulating the ground truth probability of superiority, i.e., the probability of the team scoring or giving up more points with vs without the new player. We will sample linear intervals in logodds units to give perceptually uniform steps in probability of superiority as we did before. However, now we will use this sampling strategy on both sides of the chose decision threshold. Note that we only sample p_superiority values of 0.5 or greater, where the new player is expected to _improve_ the team's preformance.

We select decision thresholds at Cohen's d of 0.9 and 0.32 which were found to be large and medium effect sizes in preregistered psychology studies. For reference, 0.9 is about the average effect size in experimental psychology, and 0.32 is about average for preregistered between subjects studies across subfields of psychology. We choose these values because they are empirically estabilished, they are reasonable thresholds for our experiment (not too high or low as to make the task too easy). The decision threshold will be a within subjects manipulation, so we are sampling two separate sets of ground truth values here.


```{r}
# target decision-making threshold(s) 
Cohens_d <- c(0.32, 0.9)

# levels of ground truth we want
n_trials <- 8 

# linear sampling of log odds for a span of ground truth probability of superiority between 0.55 and 0.95
logodds <- c(
    # sampling around the low effect size threshold
    seq(log(0.55 / (1 - 0.55)), log(pnorm((Cohens_d[1] / sqrt(2)) - 0.05) / (1 - pnorm((Cohens_d[1] / sqrt(2)) - 0.05))), length.out = n_trials / 2),
    seq(log(pnorm((Cohens_d[1] / sqrt(2)) + 0.05) / (1 - pnorm((Cohens_d[1] / sqrt(2)) + 0.05))), log(0.95 / (1 - 0.95)), length.out = n_trials / 2),
    # sampling around the high effect size threshold
    seq(log(0.55 / (1 - 0.55)), log(pnorm((Cohens_d[2] / sqrt(2)) - 0.05) / (1 - pnorm((Cohens_d[2] / sqrt(2)) - 0.05))), length.out = n_trials / 2),
    seq(log(pnorm((Cohens_d[2] / sqrt(2)) + 0.05) / (1 - pnorm((Cohens_d[2] / sqrt(2)) + 0.05))), log(0.95 / (1 - 0.95)), length.out = n_trials / 2)
  )

# convert from log odds to probability of superiority
p_superiority <- 1 / (1 + exp(-logodds))

# initialize data conditions dataframe
conds_df <- data.frame(
    "p_superiority" = p_superiority,
    "Cohens_d_threshold" = sort(rep(Cohens_d, length(p_superiority) / 2))
  )

head(conds_df)
```

We set the baseline probability of winning/keeping the award without the new player to a constant value of 0.5. The team is as likely as a coin flip to win or keep the award without the new player. This represents the scenario where there is the maximum uncertainty about outcomes without intervention. We also add a constant called point threshold which how many points users need to score in order to win an award on a given trial.

```{r}
# baseline probability of winning/keeping an award without the new player 
conds_df <- conds_df %>%
  mutate(
    baseline = 0.5,
    point_threshold = 100
  )

head(conds_df)
```

We also want to create stimuli for the practice trials. To make these trials easy, we choose probability of superiority values near 1. This way it should be obvious that the new player is worth the cost.

```{r}
# create df containting rows for practice trials
prac_df <- data.frame(
  "p_superiority" = 0.999,
  Cohens_d_threshold = Cohens_d,
  "baseline" = .5,
  "point_threshold" = 100)

# append to conditions dataframe
conds_df <- rbind(conds_df, prac_df)

head(prac_df)
```

Since judging probability of superiority might be difficult for participants, we are including a mock task to help them understand what we are asking. We ask them judge a case where probability of superiority is 50%.

```{r}
# create df containting rows for mock trial in each condition
mock_df <- data.frame(
  "p_superiority" = 0.5,
  Cohens_d_threshold = Cohens_d,
  "baseline" = .5,
  "point_threshold" = 100)

# add to conds_df
conds_df <- rbind(conds_df, mock_df)

print(mock_df)
```

We manipulate the uncertainty in predictions by using two different values for the the standard deviation of the distribution of the difference in points between the team with and without the new player (sd_diff). We set the standard deviation of the difference in points to 5 and 15 in different trials so that each level of ground truth probability of superiority is presented at each level of uncertainty. 

```{r}
# double the length of the dataframe to add two levels of uncertainty
conds_df <- map_df(seq_len(2), ~conds_df)
# add two levels of standard deviation of the difference in the number of points for the team with vs without the new player
conds_df$sd_diff <- sort(rep(c(5, 15), length(conds_df$p_superiority) / 2)) # std(with - without)

head(conds_df)
```

Since we only want practice trials and attention checks at low uncertainty where p_superiority is 0.5 and at high uncertainty where p_superiority is 0.999, we need to drop some rows.

```{r}
# drop all but two attention check trials
drop_df <- tibble(
  p_superiority = c(0.5, 0.999),
  sd_diff = c(15, 5)
)
conds_df <- conds_df %>% anti_join(drop_df, by = c("p_superiority", "sd_diff"))
```

We derive the mean difference in the number of points scored by the team with minus without the new player (mean_diff) from sd_diff and p_superiority.

```{r}
# add columns for the mean and standard deviation of the difference in the number of points for the team with vs without the new player
conds_df <- conds_df %>%
  mutate(mean_diff = sd_diff * qnorm(p_superiority)) # mean(with - without)

head(conds_df)
```

Now we calculate the summary statistics for the team with and without the new player, making the dataframe double its length. We derive the standard deviation of the points scored by the teams with and without the new player (sd) from sd_diff, variance sum law, and the assumption that the teams with or without the new player have equal and independent variances. We derive the mean number points scored by the teams with and without the new player (mean) from the threshold for winning the award, the sd of points for each version of the team, and the mean_diff between the number of points for with minus without the new player. We derive the probability of winning the award from the threshold, mean, and sd.

```{r}
# double the length of the dataframe to add information per version of the team, with a row per distribution to visualize
conds_df <- map_df(seq_len(2), ~conds_df)
conds_df$Team <- as.factor(sort(rep(c("With the New Player","Without the New Player"), length(conds_df$p_superiority) / 2)))

# add columns for the mean and standard deviation of points for each team and the probability of winning the award
conds_df <- conds_df %>%
  mutate(
    sd = sqrt(conds_df$sd_diff ^ 2 / 2), # assume equal and independent variances
    mean = if_else(Team == "Without the New Player", 
                   # team without the new player is at baseline
                   point_threshold - sd * qnorm(1 - baseline), 
                   # team with new player is at difference from baseline
                   point_threshold - sd * qnorm(1 - baseline) + mean_diff),
    p_award = pnorm((mean - point_threshold) / sd) # probability of exceeding threshold to win award
  )                  

head(conds_df)
```

We name the conditions based on the the sd_diff and probability of superiority, so we can later filter the rows belonging to the same stimulus.

```{r}
# name conditions
conds_df <- conds_df %>%
  rowwise() %>% # need to name each row differently
  mutate(condition = paste(c(sd_diff, "sd_diff", round(p_superiority, 3), "p_sup"), collapse = "_")) %>%
  ungroup() # need to undo rowwise

head(conds_df)
```

There are some duplicate row in this data from for the purpose of generating our stimuli. We'll eliminate rows representing redundant data conditions under different conditions in order to generate our stimuli. 

```{r}
conds_df <- conds_df %>% distinct(p_superiority, sd_diff, Team, .keep_all = TRUE)
```


We need to save this dataframe for analysis.

```{r eval=FALSE}
# save conds_df with the draws used to create these stimuli (for use in analysis)
save(conds_df, file = "stimuli/conds_df.Rda")
```

##Visualization Stimuli

Here, we define functions for each chart type we plan to show users, and we show the practice trial as an example.

First, let's isolate the data we want to plot.

```{r}
# get the data for the gain framing practice trial to use as an example
prac_df <- conds_df %>% filter(p_superiority == 0.999, sd_diff == 15)

head(prac_df)
```

Before we start building charting functions, we want a helper function to wrap captions and prevent them from running of the edge of our charts.

```{r echo=FALSE}
# function to draw captions in a consistent location relative to other text
wrap_label <- function(label, char_width) {
  return(lapply(strwrap(label, width = char_width, simplify = FALSE), paste, collapse="\n"))
}
```

We also set up some parameters that will remain consistent across charts, including a set x-axis domain, parameters specific to HOPs (i.e., frame rate and number of frames), and sizes for geometries and text, respectively.

```{r}
# select limits for x-axis
data_domain <- c(60, 180)

# HOPs frame rate
frame_rate <- 2.5 
# select number of draws for HOPs conditions
n_draws_hops <- 20
# select number of dots for dotplots
n_dots_qdps <- 20

# geom sizes
means_size_interval <- 24
interval_size <- 2
HOPs_size <- 9
means_size_HOPs <- 24
means_size_slab <- 36

# opacity for uncertainty encodings
opacity <- 0.65

# text formating
title_size <- 20
label_size <- 16
sublabel_size <- 14
caption_size <- 14
annotation_size <- 4.5
char_before_wrap <- 90


# set plot dimensions
dims_pix <- c(770, 462) # pixel dimensions c(770, 462)
ppi <- 75 # assume 75 ppi for the avg monitor
dims <- dims_pix / ppi # dimensions in inches
```

Now we'll create each uncertainty visualization (i.e., intervals, HOPs, quantile dotplots, and densities) with an without extrinsic encodings of the mean.

###Intervals

A chart function for visualizations showing only 95% containment intervals.

```{r}
intervals <- function(df, data_domain, title, x_label, caption, decision_threshold, threshold_label) {
  plt <- df %>% ggplot(aes(y = mean, x = rev(levels(Team)), color = Team)) +
      geom_hline(yintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", y = (decision_threshold + 2), x = "Without the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -1.8) +
      geom_errorbar(aes(ymin = mean + qnorm(0.025) * sd, ymax = mean + qnorm(0.975) * sd, width = 0, size = interval_size, alpha = opacity)) +
      coord_flip() +
      theme_bw() +
      scale_color_brewer(palette = "Set1") +
      ylim(data_domain[1], data_domain[2]) +
      labs(
        title = title,
        x = NULL,
        y = x_label,
        color = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      guides(
        size = FALSE,
        alpha = FALSE) +
      theme(
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1))
  
  return(plt)
}

intervals(df = prac_df, 
          data_domain = data_domain, 
          title = "Predicted Number of Points Scored", 
          x_label = "Points Scored",
          caption = "Intervals contain 95% of the possible numbers of points that could be scored by your team with (top) and without the new player (bottom).", 
          decision_threshold = 100, 
          threshold_label = "Above this threshold,\nyou win the award.")
```

###Intervals With Means

A chart function for visualizations showing only 95% containment intervals with means.

```{r}
intervals_w_means <- function(df, data_domain, title, x_label, caption, decision_threshold, threshold_label, label_mean = FALSE) {
  plt <- df %>% ggplot(aes(y = mean, x = rev(levels(Team)), color = Team)) +
      geom_hline(yintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", y = (decision_threshold + 2), x = "Without the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -1.8) +
      geom_errorbar(aes(ymin = mean + qnorm(0.025) * sd, ymax = mean + qnorm(0.975) * sd, width = 0, size = interval_size, alpha = opacity)) +
      geom_point(aes(y = mean), shape = 124, size = means_size_interval) + # add means
      geom_line(aes(y = mean - 1000)) + geom_point(aes(y = mean - 1000), shape = 124, size = (means_size_interval - 7)) + # hack to get legend symbols oriented properly
      coord_flip() +
      theme_bw() +
      scale_color_brewer(palette = "Set1") +
      ylim(data_domain[1], data_domain[2]) +
      labs(
        title = title,
        x = NULL,
        y = x_label,
        color = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      guides(
        size = FALSE,
        alpha = FALSE
      ) +
      theme(
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1))
  
  if (label_mean) {
    # get mean positions for each dists
    mean_with <- df %>% filter(Team == "With the New Player") %>% dplyr::select(mean) %>% as.numeric()
    mean_without <- df %>% filter(Team == "Without the New Player") %>% dplyr::select(mean) %>% as.numeric()
    
    plt <- plt + 
      geom_segment(x = 2.175, xend = 2.175, y = mean_with, yend = 97, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", x = 2.175, y = 96, label = "Average predicted score\nwith the new player", size = annotation_size, hjust = 1, vjust = 0.5) +
      geom_segment(x = 1.175, xend = 1.175, y = mean_without, yend = 97, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", x = 1.175, y = 96, label = "Average predicted score\nwithout the new player", size = annotation_size, hjust = 1, vjust = 0.5)
  }
  
  return(plt)
}

intervals_w_means(df = prac_df, 
                  data_domain = data_domain, 
                  title = "Predicted Number of Points Scored", 
                  x_label = "Points Scored",
                  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Intervals contain 95% of the possible numbers of points that could be scored.", 
                  decision_threshold = 100, 
                  threshold_label = "Above this threshold,\nyou win the award.",
                  label_mean = TRUE)
```

###Hypothetical Outcome Plots (HOPs)

A chart function for HOPs of the possible points for each version of the team.

```{r}
hops <- function(df, n_draws, frames_per_second, data_domain, title, x_label, caption, decision_threshold, threshold_label, dimensions) {
  # generate low-discrepancy sequences to shuffle draws
  sobol_matrix <- sobol(n = n_draws, dim = 2, scrambling = 3, seed = round(runif(1) * 1000))
  draw_idx_with <- rank(sobol_matrix[,1])
  draw_idx_without <- rank(sobol_matrix[,2])
  
  plt <- df %>% 
      mutate(
        quantiles = list(ppoints(n_draws)), # get n_draws equally spaced quantiles
        draws = pmap(list(quantiles, mean, sd), qnorm), # map those quantiles to draws from each distribution
        draw_n = if_else(Team == "With the New Player", # number draws differently for each distribution
                         list(draw_idx_with),
                         list(draw_idx_without))
      ) %>%
      unnest(cols = c(quantiles, draws, draw_n)) %>% # one row per draw
      ggplot(aes(y = draws, x = Team, color = Team)) +
      scale_x_discrete(limits = rev(levels(df$Team))) + # get teams in correct order (red on top)
      geom_hline(yintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", y = (decision_threshold + 2), x = "With the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -1.8) +
      geom_point(shape = 124, size = HOPs_size, alpha = opacity) +
      coord_flip() +
      theme_bw() +
      scale_color_brewer(palette = "Set1") +
      ylim(data_domain[1], data_domain[2]) +
      labs(
        title = title,
        x = NULL,
        y = x_label,
        color = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      theme(
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1)) +
      transition_manual(draw_n)
  
  animation <- animate(plt, fps = frames_per_second, nframes = n_draws, res = 100, width = dimensions[1]*100, height = dimensions[2]*100)
  
  return(animation)
}

hops(df = prac_df, 
     n_draws = n_draws_hops,
     frames_per_second = frame_rate,
     data_domain = data_domain, 
     title = "Predicted Number of Points Scored", 
     x_label = "Points Scored",
     caption = "Moving lines represent individual predictions of the number of points that could be scored by your team with (top) and without the new player (bottom).", 
     decision_threshold = 100, 
     threshold_label = "Above this threshold,\nyou win the award.",
     dimensions = c(10.26667, 6.16000))
```

###Hypothetical Outcome Plots (HOPs) with Means

A chart function for HOPs of the possible points for each version of the team, with means added.

```{r}
hops_w_means <- function(df, n_draws, frames_per_second, data_domain, title, x_label, caption, decision_threshold, threshold_label, dimensions, label_mean = FALSE) {
  # generate low-discrepancy sequences to shuffle draws
  sobol_matrix <- sobol(n = n_draws, dim = 2, scrambling = 3, seed = round(runif(1) * 1000))
  draw_idx_with <- rank(sobol_matrix[,1])
  draw_idx_without <- rank(sobol_matrix[,2])
  
  plt <- df %>% 
      mutate(
        quantiles = list(ppoints(n_draws)), # get n_draws equally spaced quantiles
        draws = pmap(list(quantiles, mean, sd), qnorm), # map those quantiles to draws from each distribution
        draw_n = if_else(Team == "With the New Player", # number draws differently for each distribution
                         list(draw_idx_with),
                         list(draw_idx_without))
      ) %>%
      unnest(cols = c(quantiles, draws, draw_n)) %>% # one row per draw
      ggplot(aes(y = draws, x = Team, color = Team)) +
      scale_x_discrete(limits = rev(levels(df$Team))) + # get teams in correct order (red on top)
      geom_hline(yintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", y = (decision_threshold + 2), x = "With the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -1.8) +
      geom_point(shape = 124, size = HOPs_size, alpha = opacity) +
      geom_point(aes(y = mean), size = means_size_HOPs, shape = 124) + # add means
      coord_flip() +
      theme_bw() +
      scale_color_brewer(palette = "Set1") +
      ylim(data_domain[1], data_domain[2]) +
      labs(
        title = title,
        x = NULL,
        y = x_label,
        color = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      theme(
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1)) +
      transition_manual(draw_n)
  
  if (label_mean) {
    # get mean positions for each dists
    mean_with <- df %>% filter(Team == "With the New Player") %>% dplyr::select(mean) %>% as.numeric()
    mean_without <- df %>% filter(Team == "Without the New Player") %>% dplyr::select(mean) %>% as.numeric()
    
    plt <- plt + 
      geom_segment(x = 2.175, xend = 2.175, y = mean_with, yend = 97, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", x = 2.175, y = 96, label = "Average predicted score\nwith the new player", size = annotation_size, hjust = 1, vjust = 0.5) +
      geom_segment(x = 1.175, xend = 1.175, y = mean_without, yend = 97, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", x = 1.175, y = 96, label = "Average predicted score\nwithout the new player", size = annotation_size, hjust = 1, vjust = 0.5)
  }
  
  animation <- animate(plt, fps = frames_per_second, nframes = n_draws, res = 100, width = dimensions[1]*100, height = dimensions[2]*100)

  return(animation)
}

hops_w_means(df = prac_df, 
             n_draws = n_draws_hops,
             frames_per_second = frame_rate,
             data_domain = data_domain, 
             title = "Predicted Number of Points Scored", 
             x_label = "Points Scored",
             caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Moving lines represent individual predictions of the number of points that could be scored.", 
             decision_threshold = 100, 
             threshold_label = "Above this threshold,\nyou win the award.",
             dimensions = c(10.26667, 6.16000),
             label_mean = FALSE)
```

###Quantile Dotplots

A chart function for quantile dotplots of the possible points for each version of the team.

```{r}
quantile_dotplots <- function(df, n_dots, data_domain, title, x_label, caption, decision_threshold, threshold_label) {
  plt <- df %>%
      ggplot(aes(dist = "norm", arg1 = mean, arg2 = sd, y = rev(levels(Team)), fill = Team)) +
      geom_vline(xintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", x = (decision_threshold + 2), y = "Without the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -4.6) +
      stat_dist_dotsh(quantiles = n_dots, binwidth = 2.115 + 2.885 * unique(df$sd_diff) / 15, scale = 0.5, dotsize = .8, stackratio = 1.25, alpha = opacity, color = NA) +
      theme_bw() +
      scale_fill_brewer(palette = "Set1") +
      coord_cartesian(
        xlim = data_domain,
        ylim = c(1.5, 2.5)) +
      labs(
        title = title,
        x = x_label,
        y = NULL,
        fill = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      theme(
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1))
  
  return(plt)
}

quantile_dotplots(df = prac_df, 
                  n_dots = n_dots_qdps,
                  data_domain = data_domain, 
                  title = "Predicted Number of Points Scored", 
                  x_label = "Points Scored",
                  caption = "Each dot represents a 5% chance that different numbers of points could be scored by your team with (top) and without the new player (bottom).", 
                  decision_threshold = 100, 
                  threshold_label = "Above this threshold,\nyou win the award.")
```

###Quantile Dotplots with Means

A chart function for quantile dotplots of the possible points for each version of the team with means added.

```{r}
quantile_dotplots_w_means <- function(df, n_dots, data_domain, title, x_label, caption, decision_threshold, threshold_label, label_mean = FALSE) {
  plt <- df %>%
      ggplot(aes(dist = "norm", arg1 = mean, arg2 = sd, y = rev(levels(Team)), fill = Team)) +
      geom_vline(xintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", x = (decision_threshold + 2), y = "Without the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -4.6) +
      stat_dist_dotsh(quantiles = n_dots, binwidth = 2.115 + 2.885 * unique(df$sd_diff) / 15, scale = 0.5, dotsize = .8, stackratio = 1.25, alpha = opacity, color = NA) +
      geom_point(aes(x = mean, color = Team), shape = 124, size = means_size_slab, show.legend = FALSE, position = position_nudge(y = 0.325)) + # add means
      theme_bw() +
      scale_fill_brewer(palette = "Set1") +
      scale_color_brewer(palette = "Set1") +
      coord_cartesian(
        xlim = data_domain,
        ylim = c(1.5, 2.5)) +
      labs(
        title = title,
        x = x_label,
        y = NULL,
        fill = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      theme(
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1))
  
  if (label_mean) {
    # get mean positions for each dists
    mean_with <- df %>% filter(Team == "With the New Player") %>% dplyr::select(mean) %>% as.numeric()
    mean_without <- df %>% filter(Team == "Without the New Player") %>% dplyr::select(mean) %>% as.numeric()
    
    plt <- plt + 
      geom_segment(y = 2.6, yend = 2.6, x = mean_with, xend = 95, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", y = 2.6, x = 94, label = "Average predicted score\nwith the new player", size = annotation_size, hjust = 1, vjust = 0.5) +
      geom_segment(y = 1.6, yend = 1.6, x = mean_without, xend = 95, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", y = 1.6, x = 94, label = "Average predicted score\nwithout the new player", size = annotation_size, hjust = 1, vjust = 0.5)
  }
  
  return(plt)
}

quantile_dotplots_w_means(df = prac_df, 
                          n_dots = n_dots_qdps,
                          data_domain = data_domain, 
                          title = "Predicted Number of Points Scored", 
                          x_label = "Points Scored",
                          caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Each dot represents a 5% chance that different numbers of points could be scored.", 
                          decision_threshold = 100, 
                          threshold_label = "Above this threshold,\nyou win the award.",
                          label_mean = TRUE)
```

###Densities

A chart function for continuous probability densities of the possible points for each version of the team.

```{r}
densities <- function(df, data_domain, title, x_label, caption, decision_threshold, threshold_label) {
  plt <- df %>% 
      ggplot(aes(dist = "norm", arg1 = mean, arg2 = sd, y = rev(levels(Team)), fill = Team)) +
      geom_vline(xintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", x = (decision_threshold + 2), y = "Without the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -4.6) +
      stat_dist_slabh(alpha = opacity, scale = 0.6) +
      theme_bw() +
      scale_fill_brewer(palette = "Set1") +
      coord_cartesian(
        xlim = data_domain,
        ylim = c(1.5, 2.5)) +
      labs(
        title = title,
        x = x_label,
        y = NULL,
        fill = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      theme(
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1))
  
  return(plt)
}

densities(df = prac_df, 
          data_domain = data_domain, 
          title = "Predicted Number of Points Scored", 
          x_label = "Points Scored",
          caption = "The height of the shaded area represents the chances that different numbers of points could be scored by your team with (top) and without the new player (bottom).", 
          decision_threshold = 100, 
          threshold_label = "Above this threshold,\nyou win the award.")
```

###Densities with Means

A chart function for continuous probability densities of the possible points for each version of the team with means added.

```{r}
densities_w_means <- function(df, data_domain, title, x_label, caption, decision_threshold, threshold_label, label_mean = FALSE) {
  plt <- df %>% 
      ggplot(aes(dist = "norm", arg1 = mean, arg2 = sd, y = rev(levels(Team)), fill = Team)) +
      geom_vline(xintercept = decision_threshold, linetype = "longdash") + # award threshold
      annotate("text", x = (decision_threshold + 2), y = "Without the New Player", label = threshold_label, size = annotation_size, hjust = 0, vjust = -4.6) +
      stat_dist_slabh(alpha = opacity, scale = 0.6) +
      geom_point(aes(x = mean, color = Team), shape = 124, size = means_size_slab, show.legend = FALSE, position = position_nudge(y = 0.325)) + # add means
      theme_bw() +
      scale_fill_brewer(palette = "Set1") +
      scale_color_brewer(palette = "Set1") +
      coord_cartesian(
        xlim = data_domain,
        ylim = c(1.5, 2.5)) +
      labs(
        title = title,
        x = x_label,
        y = NULL,
        fill = "Your Team",
        caption = wrap_label(caption, char_before_wrap)) +
      theme(
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title = element_text(size = label_size, face = "bold"),
        axis.text.y = element_blank(),
        axis.text = element_text(size = sublabel_size),
        legend.title = element_text(size = label_size, face = "bold"), 
        legend.text = element_text(size = sublabel_size),
        plot.title = element_text(size = title_size),
        plot.caption = element_text(size = caption_size, hjust = 0, vjust = -1))
  
  if (label_mean) {
    # get mean positions for each dists
    mean_with <- df %>% filter(Team == "With the New Player") %>% dplyr::select(mean) %>% as.numeric()
    mean_without <- df %>% filter(Team == "Without the New Player") %>% dplyr::select(mean) %>% as.numeric()
    
    plt <- plt + 
      geom_segment(y = 2.6, yend = 2.6, x = mean_with, xend = 95, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", y = 2.6, x = 94, label = "Average predicted score\nwith the new player", size = annotation_size, hjust = 1, vjust = 0.5) +
      geom_segment(y = 1.6, yend = 1.6, x = mean_without, xend = 95, size = 0.5, linetype = "dotted", color = "black") +
      annotate("text", y = 1.6, x = 94, label = "Average predicted score\nwithout the new player", size = annotation_size, hjust = 1, vjust = 0.5)
  }
  
  return(plt)
}

densities_w_means(df = prac_df, 
                  data_domain = data_domain, 
                  title = "Predicted Number of Points Scored", 
                  x_label = "Points Scored",
                  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). The height of the shaded area represents the chances that different numbers of points could be scored.", 
                  decision_threshold = 100, 
                  threshold_label = "Above this threshold,\nyou win the award.",
                  label_mean = TRUE)
```


##Stimuli Generation

We create one of each chart type for each data condition above and save to a folder called stimuli.

```{r eval=FALSE}
# cycle through rows in the table of data conditions
for (c in unique(conds_df$condition)) {
  # isolaten data for the current condtion
  use_df <- conds_df %>% filter(condition %in% c)
  
  # intervals
  plt <- intervals(df = use_df, 
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "Intervals contain 95% of the possible numbers of points that could be scored by your team with (top) and without the new player (bottom).", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.")
  fname <- paste("stimuli/intervals-", c,".svg", sep = "")
  ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])
  
  # intervals with means
  plt <- intervals_w_means(df = use_df, 
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Intervals contain 95% of the possible numbers of points that could be scored.", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.")
  fname <- paste("stimuli/intervals_w_means-", c, ".svg", sep = "")
  ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

  # hops
  plt <- hops(df = use_df, 
    n_draws = n_draws_hops,
    frames_per_second = frame_rate,
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "Moving lines represent individual predictions of the number of points that could be scored by your team with (top) and without the new player (bottom).", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.",
    dimensions = dims)
  fname <- paste("stimuli/HOPs-", c, ".gif", sep = "")
  anim_save(filename = fname, animation = plt)
  
  # hops with means
  plt <- hops_w_means(df = use_df, 
    n_draws = n_draws_hops,
    frames_per_second = frame_rate,
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Moving lines represent individual predictions of the number of points that could be scored.", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.",
    dimensions = dims)
  fname <- paste("stimuli/HOPs_w_means-", c, ".gif", sep = "")
  anim_save(filename = fname, animation = plt)

  # quantile dotplots
  plt <- quantile_dotplots(df = use_df, 
    n_dots = n_dots_qdps,
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "Each dot represents a 5% chance that different numbers of points could be scored by your team with (top) and without the new player (bottom).", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.")
  fname <- paste("stimuli/QDPs-", c, ".svg", sep = "")
  ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

  # quantile dotplots with means
  plt <- quantile_dotplots_w_means(df = use_df, 
    n_dots = n_dots_qdps,
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Each dot represents a 5% chance that different numbers of points could be scored.", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.")
  fname <- paste("stimuli/QDPs_w_means-", c, ".svg", sep = "")
  ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])
  
  # densities
  plt <- densities(df = use_df, 
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "The height of the shaded area represents the chances that different numbers of points could be scored by your team with (top) and without the new player (bottom).", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.")
  fname <- paste("stimuli/densities-", c, ".svg", sep = "")
  ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])
  
  # densities with means
  plt <- densities_w_means(df = use_df, 
    data_domain = data_domain, 
    title = "Predicted Number of Points Scored", 
    x_label = "Points Scored",
    caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). The height of the shaded area represents the chances that different numbers of points could be scored.", 
    decision_threshold = 100, 
    threshold_label = "Above this threshold,\nyou win the award.")
  fname <- paste("stimuli/densities_w_means-", c, ".svg", sep = "")
  ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])
}
```

##Mock and Practice Stimuli

We also create and save one of each chart type with an annotation indicating the mean for use in the mock and practice trials.

```{r eval=FALSE}
# select data for mock stimuli
mock_df <- conds_df %>% filter(p_superiority == 0.5, sd_diff == 5)
  
# intervals
plt <- intervals(df = mock_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "Intervals contain 95% of the possible numbers of points that could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.")
fname <- paste("stimuli/intervals-mock.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# intervals with means
plt <- intervals_w_means(df = mock_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Intervals contain 95% of the possible numbers of points that could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  label_mean = TRUE)
fname <- paste("stimuli/intervals_w_means-mock.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# hops
plt <- hops(df = mock_df,
  n_draws = n_draws_hops,
  frames_per_second = frame_rate,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "Moving lines represent individual predictions of the number of points that could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  dimensions = dims)
fname <- paste("stimuli/HOPs-mock.gif", sep = "")
anim_save(filename = fname, animation = plt)

# hops with means
plt <- hops_w_means(df = mock_df,
  n_draws = n_draws_hops,
  frames_per_second = frame_rate,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Moving lines represent individual predictions of the number of points that could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  dimensions = dims,
  label_mean = TRUE)
fname <- paste("stimuli/HOPs_w_means-mock.gif", sep = "")
anim_save(filename = fname, animation = plt)

# quantile dotplots
plt <- quantile_dotplots(df = mock_df,
  n_dots = n_dots_qdps,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "Each dot represents a 5% chance that different numbers of points could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.")
fname <- paste("stimuli/QDPs-mock.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# quantile dotplots with means
plt <- quantile_dotplots_w_means(df = mock_df,
  n_dots = n_dots_qdps,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Each dot represents a 5% chance that different numbers of points could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  label_mean = TRUE)
fname <- paste("stimuli/QDPs_w_means-mock.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# densities
plt <- densities(df = mock_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The height of the shaded area represents the chances that different numbers of points could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.")
fname <- paste("stimuli/densities-mock.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# densities with means
plt <- densities_w_means(df = mock_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). The height of the shaded area represents the chances that different numbers of points could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  label_mean = TRUE)
fname <- paste("stimuli/densities_w_means-mock.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])
```

```{r eval=FALSE}
# select data for practice stimuli
prac_df <- conds_df %>% filter(p_superiority == 0.999, sd_diff == 15)
  
# intervals
plt <- intervals(df = prac_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "Intervals contain 95% of the possible numbers of points that could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.")
fname <- paste("stimuli/intervals-prac.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# intervals with means
plt <- intervals_w_means(df = prac_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Intervals contain 95% of the possible numbers of points that could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  label_mean = TRUE)
fname <- paste("stimuli/intervals_w_means-prac.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# hops
plt <- hops(df = prac_df,
  n_draws = n_draws_hops,
  frames_per_second = frame_rate,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "Moving lines represent individual predictions of the number of points that could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  dimensions = dims)
fname <- paste("stimuli/HOPs-prac.gif", sep = "")
anim_save(filename = fname, animation = plt)

# hops with means
plt <- hops_w_means(df = prac_df,
  n_draws = n_draws_hops,
  frames_per_second = frame_rate,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Moving lines represent individual predictions of the number of points that could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  dimensions = dims,
  label_mean = TRUE)
fname <- paste("stimuli/HOPs_w_means-prac.gif", sep = "")
anim_save(filename = fname, animation = plt)

# quantile dotplots
plt <- quantile_dotplots(df = prac_df,
  n_dots = n_dots_qdps,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "Each dot represents a 5% chance that different numbers of points could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.")
fname <- paste("stimuli/QDPs-prac.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# quantile dotplots with means
plt <- quantile_dotplots_w_means(df = prac_df,
  n_dots = n_dots_qdps,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). Each dot represents a 5% chance that different numbers of points could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  label_mean = TRUE)
fname <- paste("stimuli/QDPs_w_means-prac.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# densities
plt <- densities(df = prac_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The height of the shaded area represents the chances that different numbers of points could be scored by your team with (top) and without the new player (bottom).",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.")
fname <- paste("stimuli/densities-prac.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])

# densities with means
plt <- densities_w_means(df = prac_df,
  data_domain = data_domain,
  title = "Predicted Number of Points Scored",
  x_label = "Points Scored",
  caption = "The red and blue vertical lines represent the average number of points that could be scored by your team with (top) and without the new player (bottom). The height of the shaded area represents the chances that different numbers of points could be scored.",
  decision_threshold = 100,
  threshold_label = "Above this threshold,\nyou win the award.",
  label_mean = TRUE)
fname <- paste("stimuli/densities_w_means-prac.svg", sep = "")
ggsave(file = fname, plot = plt, width = dims[1], height = dims[2])
```
